function getName(e){return e.name}function queryKey(e){for(var t=[],n=0;n<e.length;n++){var s=e[n];if("object"==typeof s){var o="not"===s.operator?"!":s.operator;t.push(o+getName(s.Component))}else t.push(getName(s))}return t.sort().join("-")}const hasWindow="undefined"!=typeof window,now=hasWindow&&void 0!==window.performance?performance.now.bind(performance):Date.now.bind(Date);class EventDispatcher{constructor(){this._listeners={},this.stats={fired:0,handled:0}}addEventListener(e,t){let n=this._listeners;void 0===n[e]&&(n[e]=[]),-1===n[e].indexOf(t)&&n[e].push(t)}hasEventListener(e,t){return void 0!==this._listeners[e]&&-1!==this._listeners[e].indexOf(t)}removeEventListener(e,t){var n=this._listeners[e];if(void 0!==n){var s=n.indexOf(t);-1!==s&&n.splice(s,1)}}dispatchEvent(e,t,n){this.stats.fired++;var s=this._listeners[e];if(void 0!==s)for(var o=s.slice(0),r=0;r<o.length;r++)o[r].call(this,t,n)}resetCounters(){this.stats.fired=this.stats.handled=0}}class Query{constructor(e,t){if(this.Components=[],this.NotComponents=[],e.forEach(e=>{"object"==typeof e?this.NotComponents.push(e.Component):this.Components.push(e)}),0===this.Components.length)throw new Error("Can't create a query without components");this.entities=[],this.eventDispatcher=new EventDispatcher,this.reactive=!1,this.key=queryKey(e);for(var n=0;n<t._entities.length;n++){var s=t._entities[n];this.match(s)&&(s.queries.push(this),this.entities.push(s))}}addEntity(e){e.queries.push(this),this.entities.push(e),this.eventDispatcher.dispatchEvent(Query.prototype.ENTITY_ADDED,e)}removeEntity(e){let t=this.entities.indexOf(e);~t&&(this.entities.splice(t,1),t=e.queries.indexOf(this),e.queries.splice(t,1),this.eventDispatcher.dispatchEvent(Query.prototype.ENTITY_REMOVED,e))}match(e){return e.hasAllComponents(this.Components)&&!e.hasAnyComponents(this.NotComponents)}toJSON(){return{key:this.key,reactive:this.reactive,components:{included:this.Components.map(e=>e.name),not:this.NotComponents.map(e=>e.name)},numEntities:this.entities.length}}stats(){return{numComponents:this.Components.length,numEntities:this.entities.length}}}Query.prototype.ENTITY_ADDED="Query#ENTITY_ADDED",Query.prototype.ENTITY_REMOVED="Query#ENTITY_REMOVED",Query.prototype.COMPONENT_CHANGED="Query#COMPONENT_CHANGED";class System{canExecute(){if(0===this._mandatoryQueries.length)return!0;for(let e=0;e<this._mandatoryQueries.length;e++){if(0===this._mandatoryQueries[e].entities.length)return!1}return!0}constructor(e,t){if(this.world=e,this.enabled=!0,this._queries={},this.queries={},this.priority=0,this.executeTime=0,t&&t.priority&&(this.priority=t.priority),this._mandatoryQueries=[],this.initialized=!0,this.constructor.queries)for(var n in this.constructor.queries){var s=this.constructor.queries[n],o=s.components;if(!o||0===o.length)throw new Error("'components' attribute can't be empty in a query");var r=this.world.entityManager.queryComponents(o);this._queries[n]=r,!0===s.mandatory&&this._mandatoryQueries.push(r),this.queries[n]={results:r.entities};var i=["added","removed","changed"];const e={added:Query.prototype.ENTITY_ADDED,removed:Query.prototype.ENTITY_REMOVED,changed:Query.prototype.COMPONENT_CHANGED};s.listen&&i.forEach(t=>{if(this.execute||console.warn(`System '${this.constructor.name}' has defined listen events (${i.join(", ")}) for query '${n}' but it does not implement the 'execute' method.`),s.listen[t]){let o=s.listen[t];if("changed"===t){if(r.reactive=!0,!0===o){let e=this.queries[n][t]=[];r.eventDispatcher.addEventListener(Query.prototype.COMPONENT_CHANGED,t=>{-1===e.indexOf(t)&&e.push(t)})}else if(Array.isArray(o)){let e=this.queries[n][t]=[];r.eventDispatcher.addEventListener(Query.prototype.COMPONENT_CHANGED,(t,n)=>{-1!==o.indexOf(n.constructor)&&-1===e.indexOf(t)&&e.push(t)})}}else{let s=this.queries[n][t]=[];r.eventDispatcher.addEventListener(e[t],e=>{-1===s.indexOf(e)&&s.push(e)})}}})}}stop(){this.executeTime=0,this.enabled=!1}play(){this.enabled=!0}clearEvents(){for(let t in this.queries){var e=this.queries[t];if(e.added&&(e.added.length=0),e.removed&&(e.removed.length=0),e.changed)if(Array.isArray(e.changed))e.changed.length=0;else for(let t in e.changed)e.changed[t].length=0}}toJSON(){var e={name:this.constructor.name,enabled:this.enabled,executeTime:this.executeTime,priority:this.priority,queries:{}};if(this.constructor.queries){var t=this.constructor.queries;for(let n in t){let s=this.queries[n],o=t[n],r=e.queries[n]={key:this._queries[n].key};if(r.mandatory=!0===o.mandatory,r.reactive=o.listen&&(!0===o.listen.added||!0===o.listen.removed||!0===o.listen.changed||Array.isArray(o.listen.changed)),r.reactive){r.listen={};["added","removed","changed"].forEach(e=>{s[e]&&(r.listen[e]={entities:s[e].length})})}}}return e}}class Component{}Component.isComponent=!0;class TagComponent{reset(){}}function createType(e){var t=["create","reset","clear"].filter(t=>!e[t]);if(t.length>0)throw new Error("createType expect type definition to implements the following functions: "+t.join(", "));return e.isType=!0,e}TagComponent.isTagComponent=!0;var Types={};function generateId(e){for(var t="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",s=n.length,o=0;o<e;o++)t+=n.charAt(Math.floor(Math.random()*s));return t}function injectScript(e,t){var n=document.createElement("script");n.src=e,n.onload=t,(document.head||document.documentElement).appendChild(n)}function hookConsoleAndErrors(e){["error","warning","log"].forEach(t=>{if("function"==typeof console[t]){var n=console[t].bind(console);console[t]=(...s)=>(e.send({method:"console",type:t,args:JSON.stringify(s)}),n.apply(null,s))}}),window.addEventListener("error",t=>{e.send({method:"error",error:JSON.stringify({message:t.error.message,stack:t.error.stack})})})}function includeRemoteIdHTML(e){let t=document.createElement("div");return t.style.cssText="\n    align-items: center;\n    background-color: #333;\n    color: #aaa;\n    display:flex;\n    font-family: Arial;\n    font-size: 1.1em;\n    height: 40px;\n    justify-content: center;\n    left: 0;\n    opacity: 0.9;\n    position: absolute;\n    right: 0;\n    text-align: center;\n    top: 0;\n  ",t.innerHTML=`Open ECSY devtools to connect to this page using the code:&nbsp;<b style="color: #fff">${e}</b>&nbsp;<button onClick="generateNewCode()">Generate new code</button>`,document.body.appendChild(t),t}function enableRemoteDevtools(remoteId){if(!hasWindow)return void console.warn("Remote devtools not available outside the browser");window.generateNewCode=()=>{window.localStorage.clear(),remoteId=generateId(6),window.localStorage.setItem("ecsyRemoteId",remoteId),window.location.reload(!1)},remoteId=remoteId||window.localStorage.getItem("ecsyRemoteId"),remoteId||(remoteId=generateId(6),window.localStorage.setItem("ecsyRemoteId",remoteId));let infoDiv=includeRemoteIdHTML(remoteId);window.__ECSY_REMOTE_DEVTOOLS_INJECTED=!0,window.__ECSY_REMOTE_DEVTOOLS={};let Version="",worldsBeforeLoading=[],onWorldCreated=e=>{var t=e.detail.world;Version=e.detail.version,worldsBeforeLoading.push(t)};window.addEventListener("ecsy-world-created",onWorldCreated);let onLoaded=()=>{var peer=new Peer(remoteId);peer.on("open",()=>{peer.on("connection",connection=>{window.__ECSY_REMOTE_DEVTOOLS.connection=connection,connection.on("open",(function(){infoDiv.innerHTML="Connected",connection.on("data",(function(data){if("init"===data.type){var script=document.createElement("script");script.setAttribute("type","text/javascript"),script.onload=()=>{script.parentNode.removeChild(script),window.removeEventListener("ecsy-world-created",onWorldCreated),worldsBeforeLoading.forEach(e=>{var t=new CustomEvent("ecsy-world-created",{detail:{world:e,version:Version}});window.dispatchEvent(t)})},script.innerHTML=data.script,(document.head||document.documentElement).appendChild(script),script.onload(),hookConsoleAndErrors(connection)}else if("executeScript"===data.type){let value=eval(data.script);data.returnEval&&connection.send({method:"evalReturn",value:value})}}))}))})})};injectScript("https://cdn.jsdelivr.net/npm/peerjs@0.3.20/dist/peer.min.js",onLoaded)}if(Types.Number=createType({baseType:Number,isSimpleType:!0,create:e=>void 0!==e?e:0,reset:(e,t,n)=>{e[t]=void 0!==n?n:0},clear:(e,t)=>{e[t]=0}}),Types.Boolean=createType({baseType:Boolean,isSimpleType:!0,create:e=>void 0!==e&&e,reset:(e,t,n)=>{e[t]=void 0!==n&&n},clear:(e,t)=>{e[t]=!1}}),Types.String=createType({baseType:String,isSimpleType:!0,create:e=>void 0!==e?e:"",reset:(e,t,n)=>{e[t]=void 0!==n?n:""},clear:(e,t)=>{e[t]=""}}),Types.Array=createType({baseType:Array,create:e=>void 0!==e?e.slice():[],reset:(e,t,n)=>{void 0!==n?e[t]=n.slice():e[t].length=0},clear:(e,t)=>{e[t].length=0},copy:(e,t,n)=>{e[n]=t[n].slice()}}),hasWindow){const e=new URLSearchParams(window.location.search);e.has("enable-remote-devtools")&&enableRemoteDevtools()}class KeyboardInputState extends Component{constructor(){super(),this.states={},this.mapping={" ":"jump",ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down"}}}const BUTTONS={LEFT:"left-button",PRESSED:"down",RELEASED:"up"};class MouseInputState extends Component{constructor(){super(),this.clientX=0,this.clientY=0,this.states={},this.downHandler=e=>{this.setKeyState(BUTTONS.LEFT,BUTTONS.PRESSED)},this.moveHandler=e=>{this.clientX=e.clientX,this.lastTimestamp=e.timeStamp},this.upHandler=e=>{this.setKeyState(BUTTONS.LEFT,BUTTONS.RELEASED)}}setKeyState(e,t){const n=this.getKeyState(e);n.prev=n.current,n.current=t}getKeyState(e){return this.states[e]||(this.states[e]={prev:BUTTONS.RELEASED,current:BUTTONS.RELEASED}),this.states[e]}}class GamepadInputState extends Component{constructor(){super(),this.axis_threshold=.4,this.connected=!1}}class InputState extends Component{constructor(){super(),this.states={up:!1,down:!1,left:!1,right:!1},this.changed=!0,this.released=!1}anyChanged(){return this.changed}anyReleased(){return this.released}}class ControllerConnected extends TagComponent{}class Draggable extends Component{}class Dragging extends TagComponent{}class KeyboardInputSystem extends System{constructor(){super(...arguments),this.queries={controls:{components:[KeyboardInputState,InputState],listen:{added:!0,removed:!0},added:[],results:[]}},this.on_keydown=e=>{console.log("on_keydown: "+e.key),this.setKeyState(e.key,"down")},this.on_keyup=e=>{console.log("on_keyup: "+e.key),this.setKeyState(e.key,"up")}}set debug(e){this.debug=e}execute(e,t){this.queries.controls.added.forEach(e=>{e.getMutableComponent(KeyboardInputState);document.addEventListener("keydown",this.on_keydown),document.addEventListener("keyup",this.on_keyup)}),this.queries.controls.results.forEach(e=>{this.kb||(this.kb=e.getComponent(KeyboardInputState)),this.inp||(this.inp=e.getMutableComponent(InputState)),Object.keys(this.kb.mapping).forEach(e=>{const t=this.kb.mapping[e],n=this.kb.getKeyState(e);"down"===n.current&&"up"===n.prev&&(this.inp.states[t]="down"===n.current,this.inp.changed=!0,console.log(t+" changed to "+n)),"up"===n.current&&"down"===n.prev&&(this.inp.states[t]="down"===n.current,this.inp.changed=!0,this.inp.released=!0,console.log(t+" changed to "+n)),n.prev=n.current}),console.log("key mapping",this.kb.mapping.a,this.kb.states.a,"left state",this.inp.states.left)})}setKeyState(e,t){const n=this.getKeyState(e);n.prev=n.current,n.current=t}isPressed(e){return"down"===this.getKeyState(e).current}getKeyState(e){return this.kb.states[e]||(this.kb.states[e]={prev:"up",current:"up"}),this.kb.states[e]}}class MouseInputSystem extends System{constructor(){super(...arguments),this.queries={mouse:{components:[MouseInputState,InputState],listen:{added:!0,removed:!0},added:[],results:[],removed:[]}}}set debug(e){this.debug=e}execute(e,t){this.queries.mouse.added.forEach(e=>{const t=e.getMutableComponent(MouseInputState);document.addEventListener("mousemove",t.moveHandler,!1),document.addEventListener("mousedown",t.downHandler,!1),document.addEventListener("mouseup",t.upHandler,!1)}),this.queries.mouse.results.forEach(e=>{const t=e.getComponent(MouseInputState),n=e.getMutableComponent(InputState),s=BUTTONS.LEFT,o=t.getKeyState(s);o.current===BUTTONS.PRESSED&&o.prev===BUTTONS.RELEASED&&(n.states[s]=o.current===BUTTONS.PRESSED,n.changed=!0),o.current===BUTTONS.RELEASED&&o.prev===BUTTONS.PRESSED&&(n.states[s]=o.current===BUTTONS.PRESSED,n.changed=!0,n.released=!0),o.current!==o.prev&&this.debug&&console.log("New state: "+o.current),o.prev=o.current}),this.queries.mouse.removed.forEach(e=>{const t=e.getMutableComponent(MouseInputState);t&&document.removeEventListener("mousemove",t.moveHandler)})}}class GamepadInputSystem extends System{constructor(){super(...arguments),this.queries={gamepad:{components:[GamepadInputState,InputState],listen:{added:!0,removed:!0},added:[],results:[]}}}execute(e,t){this.queries.gamepad.added.forEach(e=>{const t=e.getMutableComponent(GamepadInputState);window.addEventListener("gamepadconnected",e=>{console.log("A gamepad connected:",e.gamepad),t.connected=!0}),window.addEventListener("gamepaddisconnected",e=>{console.log("A gamepad disconnected:",e.gamepad),t.connected=!1})}),this.queries.gamepad.results.forEach(e=>{const t=e.getMutableComponent(GamepadInputState);t.connected&&this._scan_gamepads(t,e.getMutableComponent(InputState))})}_scan_gamepads(e,t){navigator.getGamepads().forEach(n=>{n.axes&&n.axes.length>=2&&(this.scan_x(e,n.axes[0],t),this.scan_y(e,n.axes[1],t))})}scan_x(e,t,n){return t<-e.axis_threshold?(n.states.left=!0,void(n.states.right=!1)):t>e.axis_threshold?(n.states.left=!1,void(n.states.right=!0)):(n.states.left=!1,n.states.right=!1,console.log("left: "+n.states.left),void console.log("right: "+n.states.right))}scan_y(e,t,n){return t<-e.axis_threshold?(n.states.up=!1,void(n.states.down=!0)):t>e.axis_threshold?(n.states.up=!0,void(n.states.down=!1)):(n.states.up=!1,n.states.down=!1,console.log("up: "+n.states.up),void console.log("down: "+n.states.down))}}const DEFAULT_OPTIONS={mouse:!0,keyboard:!0,touchscreen:!0,gamepad:!0,debug:!1};function initializeInputSystems(e,t=DEFAULT_OPTIONS){t.debug&&console.log("Initializing input systems...");const n="undefined"!=typeof window&&void 0!==window.document;if(t.debug&&(console.log("Registering input systems with the following options:"),console.log(t)),!n)return console.error("Couldn't initialize input, are you in a browser?");t.mouse&&e.registerSystem(MouseInputSystem,null),t.keyboard&&e.registerSystem(KeyboardInputSystem,null),t.gamepad&&e.registerSystem(GamepadInputSystem,null),t.debug&&console.log("INPUT: Registered input systems.")}var index=Object.freeze({__proto__:null,initializeInputSystems:initializeInputSystems,KeyboardInputState:KeyboardInputState,MouseInputState:MouseInputState,GamepadInputState:GamepadInputState,InputState:InputState,ControllerConnected:ControllerConnected,Draggable:Draggable,Dragging:Dragging,KeyboardInputSystem:KeyboardInputSystem,MouseInputSystem:MouseInputSystem,GamepadInputSystem:GamepadInputSystem});export{index as ECSYINPUT};
